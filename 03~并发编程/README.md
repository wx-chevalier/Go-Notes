# Go 并发编程

Go 语言是一门为多核和网络时代而生的编程语言，它天生就支持并发编程。Go 语言的并发特性源自于 C.A.R Hoare 在 1978 年提出的 CSP（Communicating Sequential Process，通讯顺序进程）理论。CSP 不仅有严谨的数学理论基础，还在 Hoare 参与设计的 T9000 计算机中得到了实际应用。Go 语言的主要设计者 Rob Pike 在 NewSqueak、Alef、Limbo 等语言中积累了超过 20 年的 CSP 实践经验，他看到了将 CSP 理论应用到通用编程语言中的巨大价值。

CSP 理论的核心思想非常简单：通过同步通信来实现并发。在传统的并发编程中，多个线程访问共享资源时需要通过加锁等同步机制来确保安全性。而 Go 语言采用了一种创新的方式：通过 Channel（通道）在不同的 Goroutine（Go 的轻量级线程）之间传递数据。这种方式确保了在任何时刻，一个资源都只属于一个 Goroutine，从根本上避免了数据竞争问题。Go 语言用一句经典的口号来概括这种并发编程理念：

> Do not communicate by sharing memory; instead, share memory by communicating.

这句话的含义是：不要通过共享内存来通信，而应该通过通信来共享内存。具体来说：

- Go 语言推荐使用 Channel 在多个 goroutine 之间传递数据
- Channel 不仅可以传递数据，还能确保整个过程的并发安全
- 虽然 Go 主推 Channel，但也提供了互斥量（Mutex）、条件变量（Condition）等传统的同步机制
- 这些传统同步方法作为备选方案，在特定场景下仍然有其用武之地

# Go 的并发哲学

Go 语言在并发编程方面提供了两种主要的方式:一种是基于 CSP 理论的通道(Channel)通信,另一种是传统的内存同步访问机制。这让我们在编写并发代码时需要做出选择 - 是使用 Channel 还是使用传统的锁机制。

![并发的选择](https://assets.ng-tech.icu/item/20230418155409.png)

在选择并发方案时,我们可以考虑以下几个关键问题:

## 是否需要在不同的并发单元之间传递数据所有权?

当你的程序中有一部分代码产生了数据,需要与其他部分共享这些数据时,本质上就是在转移数据的所有权。这个概念类似于在没有垃圾回收的编程语言中的内存所有权 - 为了保证并发程序的安全性,通常需要确保在同一时刻只有一个并发上下文拥有数据的所有权。Channel 非常适合实现这种数据所有权的转移。

使用 Channel 有两个显著的优势:

- 你可以创建带缓冲的通道,实现一个低开销的内存队列,有效地分离生产者和消费者
- 通过使用 Channel,你可以自然地将不同的并发组件连接在一起,使代码更具组合性

## 是否需要保护数据结构的内部状态?

如果你的主要目的是保护数据结构的内部状态,那么使用传统的内存同步原语(如互斥锁)会是更好的选择。使用同步原语的好处是,你可以将锁定关键代码段的实现细节隐藏起来,而不会增加调用方的复杂度。这种方式特别适合实现线程安全的数据类型。

# Links

- [2017~Concurrency in Go 中文笔记》📚](https://www.kancloud.cn/mutouzhang/go/596804): 以希望大家能够了解并掌握有关 Go 中并发性的高质量、全面的信息：如何使用它，如何将最佳实践和模式整合到系统中，以及它们如何在所有系统中运行。我尽力在这些考量之间取得平衡。TODO!
